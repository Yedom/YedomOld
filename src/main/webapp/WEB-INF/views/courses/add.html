<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="#{title}">Yedom</title>
    <link rel="stylesheet" href="../../resources/css/material-kit.css" th:href="@{/resources/css/material-kit.css}">
    <link rel="stylesheet" href="../../resources/css/common.css" th:href="@{/resources/css/common.css}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="../../resources/js/jquery.js" th:src="@{/resources/js/jquery.js}" rel="stylesheet"></script>
</head>
<body class="index-page sidebar-collapse">
<nav class="navbar navbar-color-on-scroll fixed-top navbar-expand-lg navbar-transparent" color-on-scroll="150">
    <div class="container">
        <div class="navbar-translate">
            <a class="navbar-brand" href="/">Yedom</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="sr-only">Toggle navigation</span>
                <span class="navbar-toggler-icon"></span>
                <span class="navbar-toggler-icon"></span>
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
        <div id="collapse navbar-collapse">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/courses" th:text="#{common.courses}"><i class="material-icons">lk</i>Курсы</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/lk" th:text="#{common.lk}"><i class="material-icons">lk</i>Личный кабинет</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
</div>

<div class="main main-raised col-md-4 mx-auto text-center section">
    <div class="container">
        <form th:method="POST" th:action="@{/courses/add}" th:object="${course}">
            <label th:for="title" th:text="#{course.title}">Название курса</label>:
            <br/>
            <textarea rows="2" cols="60" th:field="*{title}" id="title"></textarea>
            <div style="color:red" th:if="${#fields.hasErrors('title')}" th:errors="*{title}">Title Error</div>
            <br />
            <label th:for="tags" th:text="#{course.tags}">Тэги</label>:
            <br/>
            <textarea rows="8" cols="40" th:field="*{tags}" id="tags"></textarea>
            <div style="color:red" th:if="${#fields.hasErrors('tags')}" th:errors="*{tags}">Tags Error</div>
            <br />
            <div id="tagsToAdd" class="unselectable">
                <span onclick="spanClick(this)">tag1</span>
                <span onclick="spanClick(this)">tag2</span>
            </div>
            <br />
            <br />
            <input type="submit" value="Сохранить курс" th:value="#{course.add}"/>
            <br />
        </form>
    </div>
</div>

<footer class="footer" data-background-color="black">
    <div class="container">
        <nav class="float-left">
            <ul>
                <li>
                    <a target="_blank" rel="noopener noreferrer" href="https://github.com/Yedom" th:text="#{common.developers}">Разработчики</a>
                </li>
            </ul>
        </nav>
        <div class="copyright float-right">
            2022-<script>document.write(new Date().getFullYear())</script> © <text th:text="#{title}">Yedom</text>
        </div>
    </div>
</footer>

<script th:inline="javascript">
    tagsArray = [',', '.', '@', '#', '\n', '\r'];

    let title = $('#title');
    let tags = $('#tags');

    $(document).ready(function () {
        //disable copy-paste in textarea
        tags.bind('copy paste', function (e) {
            e.preventDefault();
        });
    });

    function spanClick(span) {
        span.setAttribute("hidden", "hidden");
        let tag = span.innerText;
        tags.val(removeSymbolsToLastComma(tags.val()) + tag + ', ');
    }

    //check if char symbol is special (shift, ctrl, ...)
    function isSpecialSymbol(code) {
        return code === 8 || code === 17 || code === 37 || code === 39;
    }

    title.on('keydown', function(e) {
        if(this.value.length > 100) {
            if(!isSpecialSymbol(e.keyCode)) return false;
        }
    });

    title.on('keyup', function() {
        if (this.value.length > 5) {
            let data = {title: tags.val().replaceAll(',', '') + ' ' + title.val()};
            const response = fetch("/courses/add/tagsUpdate", {
                method: "POST",
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            response.then(function (response) {

            });
        }
    });

    //remove symbols from string to last comma
    function removeSymbolsToLastComma(str) {
        let lastComma = str.lastIndexOf(',') + 2;
        if (lastComma !== -1) {
            return str.substring(0, lastComma);
        }
        return str;
    }

    //check if symbol in array
    function isSymbolInArray(symbol, array) {
        for (let i = 0; i < array.length; i++) {
            if (symbol === array[i]) {
                return true;
            }
        }
        return false;
    }

    //trim string and remove first and last spaces
    function trimString(string) {
        let result = "";
        let isSpace = false;
        for (let i = 0; i < string.length; i++) {
            if (string[i] === ' ') {
                if (!isSpace) {
                    result += string[i];
                    isSpace = true;
                }
            } else {
                result += string[i];
                isSpace = false;
            }
        }
        if (result[0] === ' ') {
            result = result.substring(1);
        }
        if (result[result.length - 1] === ' ') {
            result = result.substring(0, result.length - 1);
        }
        return result;
    }

    //remove spaces before commas
    function removeSpacesBeforeCommas(string) {
        let result = "";
        for (let i = 0; i < string.length; i++) {
            if (string[i] === ' ' && string[i + 1] === ',') {
                result += ',';
                i++;
            } else {
                result += string[i];
            }
        }
        return result;
    }

    //add space after comma if not exist
    function addSpaceAfterComma(string) {
        let result = "";
        for (let i = 0; i < string.length; i++) {
            if (string[i] === ',') {
                if (string[i + 1] !== ' ') {
                    result += ', ';
                } else {
                    result += ',';
                }
            } else {
                result += string[i];
            }
        }
        return result;
    }

    //check if comma exist from end white its space
    function isCommaExist(string) {
        for (let i = string.length - 1; i >= 0; i--) {
            if (string[i] === ',') {
                return true;
            }
            if (string[i] !== ' ') {
                return false;
            }
        }
        return false;
    }

    //select first N words in every separated by comma string
    function selectFirstNWords(string, N) {
        let result = "";
        let words = string.split(', ');
        for (let i = 0; i < words.length; i++) {
            let word = words[i];
            let wordArray = word.split(' ');
            let M = Math.min(wordArray.length, N);
            for (let j = 0; j < M; j++) {
                if (j < M) {
                    result += wordArray[j];
                    if (j < M - 1) {
                        result += ' ';
                    }
                }
            }
            if (i < words.length - 1) {
                result += ', ';
            }
        }
        return result;
    }

    //replace repeated commas in string to one
    function replaceRepeatedCommas(string) {
        let result = "";
        let isComma = false;
        for (let i = 0; i < string.length; i++) {
            if (string[i] === ',') {
                if (!isComma) {
                    result += string[i];
                    isComma = true;
                }
            } else {
                result += string[i];
                isComma = false;
            }
        }
        return result;
    }

    //get sum of symbols in array
    function getSumOfSymbolsInArray(array) {
        let sum = 0;
        for (let i = 0; i < array.length; i++) {
            sum += array[i].length;
        }
        return sum;
    }

    //processing tags string
    function processTagsString(string) {
        string = trimString(string);
        string = replaceRepeatedCommas(string);
        string = removeSpacesBeforeCommas(string);
        string = addSpaceAfterComma(string);
        string = selectFirstNWords(string, 4);
        return string;
    }

    //fit to format
    tags.on('keyup', function() {
        let sym = this.value[this.value.length - 1];
        //check if symbol is tag's separator
        if(isSymbolInArray(sym, tagsArray)) {
            let predVal = this.value.substring(0, this.value.length - 1);
            let spl = predVal.split(', ');

            this.value = predVal;
            if (!isCommaExist(this.value) && getSumOfSymbolsInArray(spl[spl.length - 1]) >= 3) {
                this.value += ', ';
                this.value = processTagsString(this.value)
            }
        }
    });

    //prevent keydown repeating
    tags.on('keydown', function(e) {
        let sym = this.value[this.value.length - 1];
        if(isSymbolInArray(sym, tagsArray)) {
            e.preventDefault();
        }
    });
</script>

<script src="../../resources/js/popper.js" th:src="@{/resources/js/popper.js}" rel="stylesheet"></script>
<script src="../../resources/js/material-design.js" th:src="@{/resources/js/material-design.js}" rel="stylesheet"></script>
<script src="../../resources/js/material-kit.js" th:src="@{/resources/js/material-kit.js}" rel="stylesheet"></script>

</body>
</html>