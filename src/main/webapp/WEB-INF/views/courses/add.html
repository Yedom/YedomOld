<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="#{title}">Yedom</title>
    <!-- Info -->
    <meta name="description" content="Yedom education platform">
    <meta name="keywords" content="yedom, education, platform, education platform, smart search, graphs, AR, AR technologies, online courses, courses, образовательная платформа, курсы, онлайн курсы">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Styles -->
    <link rel="stylesheet" href="../../resources/css/material-kit.css" th:href="@{/resources/css/material-kit.css}">
    <link rel="stylesheet" href="../../resources/css/common.css" th:href="@{/resources/css/common.css}">
    <link rel="stylesheet" href="../../resources/css/icons.css" th:href="@{/resources/css/icons.css}">
    <link rel="stylesheet" href="../../resources/css/bootstrap-select.min.css" th:href="@{/resources/css/bootstrap-select.min.css}">

    <!-- Scripts -->
    <script src="../../resources/js/jquery.js" th:src="@{/resources/js/jquery.js}" rel="stylesheet"></script>
    <script src="../../resources/js/material-kit.js" th:src="@{/resources/js/material-kit.js}" rel="stylesheet"></script>
    <script src="../../resources/js/particles.js" th:src="@{/resources/js/particles.js}" rel="stylesheet"></script>
    <script src="../../resources/js/popper.js" th:src="@{/resources/js/popper.js}" rel="stylesheet"></script>
    <script src="../../resources/js/material-design.js" th:src="@{/resources/js/material-design.js}" rel="stylesheet"></script>
    <script src="../../resources/js/bootstrap-select.min.js" th:src="@{/resources/js/bootstrap-select.min.js}" rel="stylesheet"></script>
    <script src="../../resources/js/w3.js" th:src="@{/resources/js/w3.js}" rel="stylesheet"></script>
    <script src="../../resources/js/common.js" th:src="@{/resources/js/common.js}" rel="stylesheet"></script>
</head>
<body class="index-page sidebar-collapse">

<!-- Particles Container -->
<div id="particles-container"></div>

<div th:replace="../resources/common/header.html :: header-fragment" w3-include-html="../../resources/common/header.html"></div>

<div class="bg">
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
</div>

<div class="bg unselectable">
    <div class="main main-raised col-md-4 mx-auto text-center section">
        <div class="container expanded-form">
            <form th:method="POST" th:action="@{/courses/add}" th:object="${course}">
                <label th:for="title" th:text="#{course.title}">Название курса</label>:
                <br/>
                <textarea th:placeholder="#{course.add.title}" class="textarea-add" th:field="*{title}" id="title"></textarea>
                <br />
                <label th:for="description" th:text="#{course.description}">Описание курса</label>:
                <br/>
                <textarea th:placeholder="#{course.add.description}" class="textarea-add" rows="5" th:field="*{description}" id="description"></textarea>
                <br />
                <label th:for="tags" th:text="#{course.tags.title}">Тэги</label>:
                <br/>
                <textarea th:placeholder="#{course.add.tags}" class="textarea-add" rows="10" th:field="*{tags}" id="tags"></textarea>
                <br />
                <label th:for="section" th:text="#{course.add.by}">От имени</label>:
                <br/>
                <select name="section" id="section" class="selectpicker" data-style="select-with-transition">
                    <option th:each="option : ${options}" th:value="${option.value}" th:text="${option.text}">Username</option>
                </select>
                <br />
                <div id="tagsToAdd" class="unselectable">
                </div>
                <br />
                <br />
                <input type="submit" value="Сохранить курс" th:value="#{course.save}"/>
                <br />
            </form>

            <!-- Errors -->
            <div class="errors container" th:if="${#fields.hasErrors('course.*')}">
                <h4 th:text="#{common.errors}">Errors:</h4>
                <ul>
                    <li style="color: red;" th:each="err : ${#fields.errors('course.*')}" th:text="${err}" />
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="bg">
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
</div>

<div th:replace="../resources/common/footer.html :: footer-fragment" w3-include-html="../../resources/common/footer.html"></div>

<script>
    w3.includeHTML();

    particlesJS.load('particles-container', '../../resources/assets/particles.json', function () {
        console.log('particles-js loaded!');
    });
</script>

<script th:inline="javascript">
    tagsArray = [',', '.', '@', '#', '\n', '\r'];

    let title = $('#title');
    let tags = $('#tags');

    $(document).ready(function () {
        tags.bind('copy paste', function (e) {
            e.preventDefault();
        });
        if(title.val().length >= 5) {
            updateTags();
        }
    });

    function spanClick(span) {
        if(title.val().split(', ').length < 30) {
            span.setAttribute("hidden", "hidden");
            let tag = span.innerText;
            tags.val(isCommaExistFromEnd(tags.val()) ? tags.val() + tag : tags.val() + ', ' + tag);
            updateTags();
        }
    }

    //remove repeated tags
    function processTags(dataTags) {
        let splTags = tags.val().split(', ');
        splTags.forEach(function (splTag) {
            if(splTag.length > 0) {
                dataTags = dataTags.replaceAll(
                    "<span onclick=\"spanClick(this)\">" + splTag + "</span>", "");
            }
        });
        return dataTags;
    }

    function updateTags() {
        let data = tags.val() + '@' + title.val();
        fetch("/courses/add/tagsUpdate?tags="+data)
            .then((response) => response.json())
            .then((data) => {
                //console.log(data.tags);
                $('#tagsToAdd').html(processTags(data.tags));
            });
    }

    title.on('keydown', function(e) {
        if(title.val().split(', ').length >= 30) {
            if(!isSpecialSymbol(e.keyCode)) return false;
        }
    });

    title.on('keyup', function () {
        if(this.value.length >= 5) {
            updateTags();
        }
        else {
            $('#tagsToAdd').html("");
        }
    });

    //fit to format
    tags.on('keyup', function(e) {
        let sym = this.value[this.value.length - 1];
        //check if symbol is tag's separator
        if(isSymbolInArray(sym, tagsArray) && e.keyCode !== 8) {
            let predVal = this.value.substring(0, this.value.length - 1);
            let spl = predVal.split(', ');

            this.value = predVal;
            if (!isCommaExist(this.value) && getSumOfSymbolsInArray(spl[spl.length - 1]) >= 3) {
                this.value += ', ';
                this.value = processTagsString(this.value)
            }
            updateTags();
        }
    });

    //prevent keydown repeating
    tags.on('keydown', function(e) {
        let sym = this.value[this.value.length - 1];
        if(isSymbolInArray(sym, tagsArray) && e.keyCode !== 8) {
            e.preventDefault();
        }
    });
</script>
</body>
</html>